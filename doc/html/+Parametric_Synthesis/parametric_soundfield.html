<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of parametric_soundfield</title>
  <meta name="keywords" content="parametric_soundfield">
  <meta name="description" content="">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">+Parametric_Synthesis</a> &gt; parametric_soundfield.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for +Parametric_Synthesis&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>parametric_soundfield
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong></strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>This is a script file. </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="parametric_soundfield.html" class="code" title="">parametric_soundfield</a>	</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="parametric_soundfield.html" class="code" title="">parametric_soundfield</a>	</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function obj = createEmptySoundfield(obj)</a></li><li><a href="#_sub2" class="code">function obj = createSoundfield(obj)</a></li><li><a href="#_sub3" class="code">function obj = reproduceSoundfield(obj,model)</a></li><li><a href="#_sub4" class="code">function p = convolutionalModel(obj, Th, R0, Directions, Frequency)</a></li><li><a href="#_sub5" class="code">function obj = setTau(obj, t, z)</a></li><li><a href="#_sub6" class="code">function obj = set_fd(obj, fd)</a></li><li><a href="#_sub7" class="code">function fd = get_fd(obj)</a></li><li><a href="#_sub8" class="code">function obj = set_f1(obj, f1)</a></li><li><a href="#_sub9" class="code">function f1 = get_f1(obj)</a></li><li><a href="#_sub10" class="code">function obj = set_f2(obj, f2)</a></li><li><a href="#_sub11" class="code">function f2 = get_f2(obj)</a></li><li><a href="#_sub12" class="code">function h = plotSoundfield(obj, field, field_type, colour)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 classdef <a href="parametric_soundfield.html" class="code" title="">parametric_soundfield</a>
0002     <span class="comment">%PARAMETRIC_SOUNDFIELD Summary of this class goes here</span>
0003     <span class="comment">%   Detailed explanation goes here</span>
0004     
0005     <span class="comment">% Author: Jacob Donley</span>
0006     <span class="comment">% University of Wollongong</span>
0007     <span class="comment">% Email: jrd089@uowmail.edu.au</span>
0008     <span class="comment">% Copyright: Jacob Donley 2016</span>
0009     <span class="comment">% Date: 13 May 2016</span>
0010     <span class="comment">% Revision: 0.1</span>
0011     <span class="comment">%</span>
0012     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0013     
0014     
0015     <span class="comment">% Public Properties</span>
0016     properties (Access = public)
0017         <span class="comment">% Field Parameters</span>
0018         res = 50;  <span class="comment">% samples per metre %Resolution of soundfield</span>
0019         field_size = []; <span class="comment">% [X, Y]</span>
0020 
0021         P1 = 1;
0022         P2 = 0.99;
0023         omega;<span class="comment">% Angular frequency of carrier wave</span>
0024         
0025         <span class="comment">% Modulation parameters</span>
0026         m = 0.5;
0027         mode = <span class="string">'USB'</span>; <span class="comment">% Upper Sideband (USB) or Lower Sideband (LSB)</span>
0028         
0029         <span class="comment">% Transducer Parameters</span>
0030         Spkr_Dimensions = [0.12 0.1 0.12]; <span class="comment">% metres</span>
0031         <span class="comment">%A = 0.2; %Cross sectional area in metres^2</span>
0032         Origin = [0, 0]; <span class="comment">% [X, Y]</span>
0033         Angle = 30; <span class="comment">% Parametric array source angle in degrees</span>
0034         
0035         <span class="comment">%%% Environmental Parameters</span>
0036         
0037         <span class="comment">% https://en.wikibooks.org/wiki/Engineering_Acoustics/The_Acoustic_Parameter_of_Nonlinearity</span>
0038         <span class="comment">% https://en.wikipedia.org/wiki/Nonlinear_acoustics</span>
0039         Beta = 1.2; <span class="comment">% Coefficient of non-linearity (Beta = 1 + 1/2 * B/A for fluids) (B/A = 0.4 for Diatomic Gases (Air))</span>
0040         
0041         c = 343; <span class="comment">%Speed of sound in air</span>
0042         rho = 1.225; <span class="comment">% Density of medium</span>
0043         
0044         <span class="comment">%Following ISO 9613-1. http://resource.npl.co.uk/acoustics/techguides/absorption/</span>
0045         alpha1 = 1.1639; <span class="comment">%Absorption Coefficient of ultrasound primary frequency 1  (20degC, 50%Humid., 40kHz, 101.325kPa)</span>
0046         alpha2 = 1.1639; <span class="comment">%Absorption Coefficient of ultrasound primary frequency 2  (20degC, 50%Humid., 40kHz, 101.325kPa)</span>
0047         
0048         tau; <span class="comment">%Retarded time</span>
0049         
0050          <span class="comment">% Results</span>
0051             <span class="comment">% 3D</span>
0052             Soundfield = [];
0053     <span class="keyword">end</span>
0054     
0055     <span class="comment">% Private Properties</span>
0056     properties (Access = private)
0057         f1 = 40000; <span class="comment">% Carrier frequency (Primary frequency 1)</span>
0058         f2 = 42000; <span class="comment">% Modulated frequency (Primary frequency 2)</span>
0059         fd = 2000;  <span class="comment">% Message frequency (Difference frequency)</span>
0060     <span class="keyword">end</span>
0061     
0062     
0063     <span class="comment">%% Private Methods</span>
0064     methods (Access = public)
0065 <span class="comment">%         function obj = parametric_soundfield(~)</span>
0066 <span class="comment">%             obj.omega = 2 * pi * obj.f1;</span>
0067 <span class="comment">%         end</span>
0068         
0069         <a name="_sub0" href="#_subfunctions" class="code">function obj = createEmptySoundfield(obj)</a>
0070                 wi = int16(obj.res * obj.field_size(1));
0071                 le = int16(obj.res * obj.field_size(2));
0072                 obj.Soundfield = zeros(wi,le);                
0073         <span class="keyword">end</span>
0074         
0075     <span class="keyword">end</span>
0076     
0077 <span class="comment">%% Public Methods</span>
0078     methods
0079         
0080         <a name="_sub1" href="#_subfunctions" class="code">function obj = createSoundfield(obj)            </a>
0081             <span class="keyword">if</span> length(obj.field_size) ~= 2
0082                 error(<span class="string">'Soundfield size has not been set correctly (Two dimensions).'</span>);
0083             <span class="keyword">end</span>
0084             
0085             obj = obj.createEmptySoundfield();
0086             
0087             obj = obj.reproduceSoundfield();
0088             
0089         <span class="keyword">end</span>
0090         
0091         <a name="_sub2" href="#_subfunctions" class="code">function obj = reproduceSoundfield(obj,model)</a>
0092             <span class="keyword">if</span> nargin&lt;2
0093                 model=<span class="string">''</span>;
0094             <span class="keyword">end</span>
0095             t = 0; <span class="comment">%time zero</span>
0096             
0097             wi = size(obj.Soundfield,1);
0098             le = size(obj.Soundfield,2);
0099             
0100             O = obj.Origin*obj.res;
0101             
0102             x = (1:wi) - O(1) - 1;
0103             y = (1:le) - O(2) - 1;            
0104             [xx, yy] = meshgrid( x/obj.res, y/obj.res );
0105             [Th,R0] = cart2pol( xx, yy );
0106              
0107             rotAng = obj.Angle/180*pi;
0108             <span class="keyword">if</span> mod( rotAng + pi/2, 2*pi ) &gt; pi <span class="comment">% Flip angle mesh every 180 degrees so there is no dicontinuity</span>
0109                 Th = rot90(rot90(Th));
0110                 rotAng = rotAng - pi;
0111             <span class="keyword">end</span>            
0112             rotAng = mod(rotAng + pi, 2*pi) - pi; <span class="comment">% Limit range from -pi to pi</span>
0113             Th = Th - rotAng;
0114             mask = ((Th &lt; pi/2) &amp; (Th &gt; - pi/2)); <span class="comment">% Force positive directivity only (one-sided parametric array source)</span>
0115             R0 = R0 .* mask;
0116             Th = Th .* mask;
0117             
0118             <span class="keyword">if</span> strcmp(model,<span class="string">'convolutional'</span>)
0119                 
0120                 p = obj.convolutionalModel(Th,R0,zeros(size(Th)));
0121                 
0122             <span class="keyword">else</span>
0123                 
0124                 omega_d = 2*pi*obj.fd;
0125                 
0126                 p = ( obj.Beta * obj.P1 * obj.P2 * omega_d^2) ./ (4*pi*obj.rho*obj.c^4 .* R0 *(obj.alpha1+obj.alpha2)) <span class="keyword">...</span>
0127                     .* (-1 + 1i*omega_d*tan(Th).^2 / (2*obj.c*(obj.alpha1+obj.alpha2)) ).^(-1) <span class="keyword">...</span>
0128                     .* exp(-1i*omega_d * (t - R0/obj.c));                            
0129                 
0130             <span class="keyword">end</span>
0131             
0132             
0133             p( isinf(p) ) = 0;
0134             
0135             obj.Soundfield = p ./ max(p(:));
0136             
0137         <span class="keyword">end</span>
0138         
0139         <a name="_sub3" href="#_subfunctions" class="code">function p = convolutionalModel(obj, Th, R0, Directions, Frequency)</a>
0140             t=0;
0141             <span class="keyword">if</span> nargin &lt; 5 || isempty(Frequency)
0142                 omega_d = 2*pi*obj.fd(:);
0143             <span class="keyword">else</span>
0144                 omega_d = 2*pi * Frequency(:);
0145             <span class="keyword">end</span>
0146             
0147             <span class="keyword">if</span> mod( Directions + pi/2, 2*pi ) &gt; pi <span class="comment">% Flip angle mesh every 180 degrees so there is no dicontinuity</span>
0148                 Th = rot90(rot90(Th));
0149                 Directions = Directions - pi;
0150             <span class="keyword">end</span>            
0151             Directions = mod(Directions + pi, 2*pi) - pi; <span class="comment">% Limit range from -pi to pi</span>
0152             Th = Th - Directions;
0153             mask = ((Th &lt; pi/2) &amp; (Th &gt; - pi/2)); <span class="comment">% Force positive directivity only (one-sided parametric array source)</span>
0154             Th = Th .* mask;
0155             R0 = R0 .* mask;            
0156             
0157             psi = linspace(-pi,pi,180)';
0158             
0159             sz_1 = size(Th,1);
0160             sz_2 = size(Th,2);
0161             sz_om = size(omega_d,1);     
0162             sz_psi= length(psi);
0163             
0164             Th      = permute( repmat( Th     , 1   , 1   , sz_om, sz_psi ), [1 2 3 4]);
0165             R0      = permute( repmat( R0     , 1   , 1   , sz_om, sz_psi ), [1 2 3 4]);
0166             omega_d = permute( repmat( omega_d, 1   , sz_1, sz_2 , sz_psi ), [2 3 1 4]);
0167             psi_n   = permute( repmat( psi    , 1   , sz_1, sz_2 , sz_om  ), [2 3 4 1]);
0168             
0169             alpha_s = obj.alpha1+obj.alpha2;
0170             <span class="comment">%spkr_r = sqrt(sum(obj.Spkr_Dimensions(1:2).^2)); % approximate speaker radius</span>
0171             spkr_r = sqrt(prod(obj.Spkr_Dimensions(1:2))/pi); <span class="comment">% approximate speaker radius</span>
0172             k1 = 2*pi*obj.f1/obj.c;
0173             k2 = 2*pi*obj.f2/obj.c;
0174             k_d = omega_d / obj.c;
0175             K = ( obj.Beta * omega_d.^2) ./ (4*pi*obj.rho*obj.c^4 .* R0 * alpha_s);
0176             D_W = alpha_s./ sqrt( alpha_s^2 + k_d.^2.*tan(Th-psi_n).^4 );
0177 <span class="comment">%             D_W = 1./ sqrt( 1 + (omega_d.^2 * tan(Th).^2)./(4*obj.c^2*(obj.alpha1+obj.alpha2)^2) );</span>
0178             D_1 = exp( -1/4 *(k1*spkr_r)^2 * tan(psi_n).^2);
0179             D_2 = exp( -1/4 *(k2*spkr_r)^2 * tan(psi_n).^2);
0180             
0181 <span class="comment">%             p = K(:,:,:,1).*cos(omega_d(:,:,:,1)*t - k_d(:,:,:,1).*R0(:,:,:,1)).* sum(D_1.*D_2.*D_W,4);</span>
0182             
0183               p = K(:,:,:,1) .* sum(D_1.*D_2.*D_W,4) .* exp(-1i*omega_d(:,:,:,1) .* (t - R0(:,:,:,1)/obj.c));
0184 
0185 <span class="comment">%             p = ( obj.Beta * omega_d(:,:,:,1).^2) ./ (4*pi*obj.rho*obj.c^4 .* R0(:,:,:,1) *(obj.alpha1+obj.alpha2)) ...</span>
0186 <span class="comment">%                  .* sum( D_1 .* D_2 ...</span>
0187 <span class="comment">%                  .* abs((-1 + 1i*omega_d.*tan(Th-psi_n).^2 / (2*obj.c*(obj.alpha1+obj.alpha2)) ).^(-1)) , 4 ) ...</span>
0188 <span class="comment">%                 .* exp(-1i*omega_d(:,:,:,1) .* (t - R0(:,:,:,1)/obj.c));</span>
0189             
0190 <span class="comment">%             p = ( obj.Beta * obj.P1 * obj.P2 * omega_d(:,:,:,1).^2) ./ (4*pi*obj.rho*obj.c^4 .* R0(:,:,:,1) *(obj.alpha1+obj.alpha2)) ...</span>
0191 <span class="comment">%                 .* (-1 + 1i*omega_d(:,:,:,1).*tan(Th(:,:,:,1)).^2 / (2*obj.c*(obj.alpha1+obj.alpha2)) ).^(-1) ...</span>
0192 <span class="comment">%                 .* exp(-1i*omega_d(:,:,:,1) .* (t - R0(:,:,:,1)/obj.c));</span>
0193             
0194             p = squeeze(p);
0195         <span class="keyword">end</span>
0196         
0197         <a name="_sub4" href="#_subfunctions" class="code">function obj = setTau(obj, t, z)</a>
0198            obj.tau = t - z/obj.c; 
0199         <span class="keyword">end</span>
0200         
0201         <a name="_sub5" href="#_subfunctions" class="code">function obj = set_fd(obj, fd)</a>
0202            obj.fd = fd;
0203            obj.f2 = obj.f1 + obj.fd;
0204         <span class="keyword">end</span>
0205         <a name="_sub6" href="#_subfunctions" class="code">function fd = get_fd(obj)</a>
0206             fd = obj.fd;
0207         <span class="keyword">end</span>
0208         
0209         <a name="_sub7" href="#_subfunctions" class="code">function obj = set_f1(obj, f1)</a>
0210            obj.f1 = f1;
0211            obj.f2 = obj.f1 + obj.fd;
0212         <span class="keyword">end</span>
0213         <a name="_sub8" href="#_subfunctions" class="code">function f1 = get_f1(obj)</a>
0214             f1 = obj.f1;
0215         <span class="keyword">end</span>
0216         
0217         <a name="_sub9" href="#_subfunctions" class="code">function obj = set_f2(obj, f2)</a>
0218            obj.f2 = f2;
0219            obj.f1 = obj.f2 - obj.fd;
0220         <span class="keyword">end</span>
0221         <a name="_sub10" href="#_subfunctions" class="code">function f2 = get_f2(obj)</a>
0222             f2 = obj.f2;
0223         <span class="keyword">end</span>
0224         
0225         <span class="comment">%%</span>
0226         <a name="_sub11" href="#_subfunctions" class="code">function h = plotSoundfield(obj, field, field_type, colour)</a>
0227             <span class="keyword">if</span> nargin &lt; 4; colour = parula; <span class="keyword">end</span>;
0228             <span class="keyword">if</span> nargin &lt; 3; field_type = <span class="string">'real'</span>; <span class="keyword">end</span>;
0229             <span class="keyword">if</span> nargin &lt; 2; field = obj.Soundfield; <span class="keyword">end</span>;
0230             
0231             <span class="comment">%%% Show parametric-style field strength</span>
0232             <span class="keyword">if</span> strcmp(field_type, <span class="string">'complex'</span>)
0233                 F = mag2db(abs(field));
0234                 CaxisSize = db2mag(max(F(:)) - 35);
0235             <span class="keyword">elseif</span> strcmp(field_type, <span class="string">'real'</span>)
0236                 F = abs(real(field));
0237                 CaxisSize = max(F(:));
0238             <span class="keyword">else</span>
0239                 error(<span class="string">'Incompatible field type.'</span>);
0240             <span class="keyword">end</span>
0241             
0242             <span class="keyword">if</span> ~isempty(F(:))
0243                 CaxisSize = CaxisSize*4/3;
0244             <span class="keyword">end</span>            
0245             <span class="comment">%%%</span>
0246             
0247             <span class="comment">%XYTick = [1 length(field)/4 length(field)/2 length(field)*3/4 length(field)];</span>
0248             <span class="comment">%XYTickLabel = { -length(field)/2/obj.res, -length(field)/4/obj.res, 0, length(field)/4/obj.res, length(field)/2/obj.res};</span>
0249             XYTick = [1  length(field)/2  length(field)];
0250             XYTickLabel = { -length(field)/2/obj.res,  0,  length(field)/2/obj.res};
0251             
0252             <span class="comment">%             subplot(1,2,1);</span>
0253             h = surf(real(field),<span class="string">'EdgeColor'</span>,<span class="string">'None'</span>);
0254             colormap(colour);
0255             view(2);
0256             title(<span class="string">'Real'</span>,<span class="keyword">...</span>
0257                 <span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="keyword">...</span>
0258                 <span class="string">'FontSize'</span>,24,<span class="keyword">...</span>
0259                 <span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
0260             axis(<span class="string">'square'</span>);
0261             box on;
0262             axis([1 length(field) 1 length(field)]);
0263             set(gca, <span class="string">'XTick'</span>, XYTick); set(gca, <span class="string">'XTickLabel'</span>, XYTickLabel);
0264             set(gca, <span class="string">'YTick'</span>, XYTick); set(gca, <span class="string">'YTickLabel'</span>, XYTickLabel);
0265             set(gca, <span class="string">'FontSize'</span>, 16);
0266             set(gca, <span class="string">'FontName'</span>, <span class="string">'Arial'</span>);
0267             <span class="comment">% Create xlabel</span>
0268             xlabel(<span class="string">'Width (metres)'</span>,<span class="string">'FontSize'</span>,20,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
0269             <span class="comment">% Create ylabel</span>
0270             ylabel(<span class="string">'Length (metres)'</span>,<span class="string">'FontSize'</span>,20,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
0271             <span class="comment">% Create zlabel</span>
0272             zlabel(<span class="string">'Amplitude'</span>,<span class="string">'Visible'</span>,<span class="string">'off'</span>);
0273             caxis([-CaxisSize CaxisSize]);
0274             <span class="keyword">if</span> (strcmp(version(<span class="string">'-release'</span>), <span class="string">'2012b'</span>))
0275                 tick_str = <span class="string">'Ztick'</span>;
0276             <span class="keyword">else</span>                
0277                 tick_str = <span class="string">'Ticks'</span>;
0278             <span class="keyword">end</span>
0279             colorbar(tick_str,[-1 -0.5 0 0.5 1],<span class="string">'FontSize'</span>,16, <span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
0280            
0281             
0282         <span class="keyword">end</span>
0283         
0284 
0285         
0286     <span class="keyword">end</span>
0287     
0288 <span class="keyword">end</span>
0289</pre></div>
<hr><address>Generated on Sun 09-Jul-2017 20:35:18 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>