<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of Calibrate_MSR_Loudspeaker_Signals</title>
  <meta name="keywords" content="Calibrate_MSR_Loudspeaker_Signals">
  <meta name="description" content="">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="../index.html">+Speaker_Setup</a> &gt; <a href="index.html">+Calibration</a> &gt; Calibrate_MSR_Loudspeaker_Signals.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for +Speaker_Setup\+Calibration&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>Calibrate_MSR_Loudspeaker_Signals
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong></strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function Calibrate_MSR_Loudspeaker_Signals(SYS) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function Calibrate_MSR_Loudspeaker_Signals(SYS)</a>
0002 clear;
0003 
0004 <span class="comment">%% Setup Information</span>
0005 <span class="keyword">if</span> nargin &lt; 1, SYS = Current_Systems.loadCurrentSRsystem; <span class="keyword">end</span>
0006 
0007 <span class="comment">%Flip loudspeaker order (effectively flips entire setup) (false if not needed)</span>
0008 <span class="keyword">if</span> isfield(SYS.system_info,<span class="string">'MirrorSetup'</span>), MirrorSetup = SYS.system_info.MirrorSetup;
0009 <span class="keyword">else</span> MirrorSetup = false; <span class="keyword">end</span>
0010 
0011 <span class="comment">% If a realworld recording is not specified in the system then abort</span>
0012 <span class="keyword">if</span> ~any(strcmpi(strrep(SYS.signal_info.recording_type,<span class="string">'-'</span>,<span class="string">''</span>),<span class="string">'realworld'</span>)), delete(gcp(<span class="string">'nocreate'</span>)); <span class="keyword">return</span>; <span class="keyword">end</span>
0013 
0014 <span class="comment">%%</span>
0015 <span class="comment">% for ss = 1:numel(SYS.Main_Setup)</span>
0016 <span class="comment">%     SYS_ = SYS;</span>
0017 <span class="comment">%     SYS_.Main_Setup = SYS_.Main_Setup(ss);</span>
0018 
0019 N = length(SYS.signal_info.methods_list_clean(SYS.signal_info.methods_list_clean&gt;=1)) <span class="keyword">...</span>
0020     + length(SYS.signal_info.methods_list_masker(SYS.signal_info.methods_list_masker&gt;=1));
0021 paired = isfield(SYS.signal_info,<span class="string">'methods_list_paired'</span>) &amp;&amp; SYS.signal_info.methods_list_paired;
0022 
0023 <span class="keyword">for</span> typ = 1:N
0024     
0025     SYS.signal_info.method = SYS.signal_info.methods_list{typ};
0026     SYS_ = SYS;
0027     
0028     tmp_levels = SYS_.signal_info.L_noise_mask;
0029     
0030     <span class="keyword">if</span> any( typ == SYS_.signal_info.methods_list_clean )
0031         Setup = SYS_.Main_Setup(typ == SYS_.signal_info.methods_list_clean);
0032         <span class="keyword">if</span> paired
0033             SYS_.Masker_Setup = SYS_.Masker_Setup(typ == SYS_.signal_info.methods_list_clean);
0034         <span class="keyword">end</span>
0035         noise_levels = -inf;
0036     <span class="keyword">elseif</span> any( typ == SYS_.signal_info.methods_list_masker )
0037         Setup = SYS_.Masker_Setup(typ == SYS_.signal_info.methods_list_masker);
0038         <span class="keyword">if</span> paired
0039             SYS_.Main_Setup = SYS_.Main_Setup(typ == SYS_.signal_info.methods_list_masker);
0040         <span class="keyword">end</span>
0041         noise_levels = SYS_.signal_info.L_noise_mask;
0042     <span class="keyword">else</span>
0043         error([<span class="string">'The method '''</span> SYS_.signal_info.method <span class="string">''' is not set as a clean or masker signal'</span>])
0044     <span class="keyword">end</span>
0045     
0046     
0047     fprintf(<span class="string">'\n===== Calibrating Loudspeaker Signals =====\n'</span>);
0048     fprintf(<span class="string">'\tSignal Type: %s\n'</span>, SYS_.signal_info.method);
0049     fprintf(<span class="string">'\t Completion: '</span>); n=0; tic;
0050     M = length(noise_levels);
0051     
0052     <span class="comment">%% Load Fiters</span>
0053     filter_location = Tools.getAllFiles([SYS_.system_info.Drive SYS_.system_info.FilterData_dir]);
0054     filter_location(~contains( filter_location, <span class="string">'EQ'</span>))=[];
0055     filter_location = sort(filter_location);
0056     filts = load( filter_location{1} ); <span class="comment">% 1st element should be the newest (most recent) set of filters</span>
0057     <span class="keyword">if</span> MirrorSetup
0058         filts.EQ = flip(filts.EQ,2);
0059     <span class="keyword">end</span>
0060     
0061     <span class="keyword">for</span> m = 1:M
0062         noise_mask = noise_levels(m);
0063         
0064         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0065         SYS_.signal_info.L_noise_mask = noise_mask; <span class="comment">% dB</span>
0066         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0067         
0068         
0069         <span class="comment">%% Get Paths and files</span>
0070         [Spkr_path,~,~,~,~,~,path_ext] = <span class="keyword">...</span>
0071             Broadband_Tools.getLoudspeakerSignalPath( Setup, SYS_.signal_info, SYS_.system_info.LUT_resolution, SYS_.system_info.Drive, <span class="string">'new'</span>);
0072         
0073         files = Tools.getAllFiles(Spkr_path);
0074         files = sort(files);
0075         
0076         isMasker = contains(lower(SYS_.signal_info.method), <span class="string">'masker'</span>); <span class="comment">%if a masker</span>
0077         <span class="comment">% Continue with only the files that are contained in the original</span>
0078         <span class="comment">% source folder unless a Masker signal is being processed (these are</span>
0079         <span class="comment">% named as Maskers)</span>
0080         <span class="keyword">if</span> ~isMasker
0081             files = Tools.keepFilesFromFolder( files, SYS_.signal_info.speech_filepath);
0082         <span class="keyword">end</span>
0083         <span class="keyword">if</span> isempty(files), error(<span class="string">'No loudspeaker signals found. Have they been generated?'</span>); <span class="keyword">end</span>
0084         
0085         <span class="comment">%%</span>
0086         fileName_prev = <span class="string">''</span>;
0087         Speaker_Signals = [];
0088         Speaker_Signals_ = [];
0089         
0090         F=length(files);
0091         <span class="keyword">for</span> f = 1:F
0092             
0093             [~, fileName, fileExt] = fileparts(files{f});
0094             <span class="keyword">if</span> ~contains(  fileName, <span class="string">'Original'</span>  ) <span class="comment">% If not an Original audio file</span>
0095                 <span class="keyword">try</span>
0096                     y = audioread(files{f});
0097                 <span class="keyword">catch</span> err
0098                     <span class="keyword">if</span> strcmp(err.identifier, <span class="string">'MATLAB:audiovideo:audioread:FileTypeNotSupported'</span>)
0099                         <span class="keyword">continue</span>; <span class="comment">% Skip unsupported files</span>
0100                     <span class="keyword">end</span>
0101                 <span class="keyword">end</span>
0102                 
0103                 <span class="comment">% Get the file number and file name</span>
0104                 [fnumflip,fnameflip] = strtok( flip(fileName), SYS_.system_info.sc );
0105                 Current_Spkr_Num = str2double( flip( fnumflip ) );
0106                 fileName_curr = flip(sscanf(fnameflip,[<span class="string">'%*['</span> SYS_.system_info.sc <span class="string">']%s'</span>]));
0107                 
0108                 <span class="keyword">if</span> sum(size(y)&gt;1) == 1 <span class="comment">% If not a multichannel audio file</span>
0109                     <span class="keyword">if</span> ~(isempty(fileName_prev) || strcmp( fileName_curr, fileName_prev))
0110                         Speaker_Signals_ = [];
0111                     <span class="keyword">end</span>
0112                     
0113                     Speaker_Signals_(Current_Spkr_Num,:) = y;
0114                     <span class="keyword">if</span> sum( any( Speaker_Signals_, 2 ) ) == Setup.Loudspeaker_Count
0115                         Speaker_Signals = Speaker_Signals_;
0116                     <span class="keyword">end</span>
0117                     
0118                 <span class="keyword">elseif</span> sum(size(y)&gt;1) &gt; 1 <span class="comment">% If a multichannel audio file</span>
0119                     Speaker_Signals = y.';
0120                 <span class="keyword">else</span>
0121                     error([<span class="string">'Failed to read audio file: '</span> fileName]);
0122                 <span class="keyword">end</span>
0123                 
0124                 <span class="keyword">if</span> sum( any( Speaker_Signals, 2 ) ) == Setup.Loudspeaker_Count <span class="comment">% If we have a complete group of speaker signals</span>
0125                     Speaker_Signals = Speaker_Signals.';
0126                     Speaker_Signals = flip(Speaker_Signals,2); <span class="comment">% Speakers are in reverse order</span>
0127                     
0128                     <span class="comment">%% Read original file</span>
0129                     <span class="keyword">if</span> isempty(strfind(SYS_.signal_info.method, <span class="string">'Masker'</span>)) <span class="comment">% If the signals are not Maskers then read the Original audio</span>
0130                         <span class="keyword">try</span>
0131                             orig = audioread( [Spkr_path, fileName_curr, SYS_.system_info.sc, <span class="string">'Original'</span>, fileExt] ); <span class="comment">% Assumes same file extension as loudspeaker audio files</span>
0132                         <span class="keyword">catch</span> err
0133                             <span class="keyword">if</span> strcmp(err.identifier, <span class="string">'MATLAB:audiovideo:audioread:FileTypeNotSupported'</span>)
0134                                 error(<span class="string">'Error reading the Original audio file for the reproduction.'</span>); <span class="comment">% Skip unsupported files</span>
0135                             <span class="keyword">end</span>
0136                         <span class="keyword">end</span>
0137                     <span class="keyword">else</span>
0138                         orig=[];
0139                     <span class="keyword">end</span>
0140                     
0141                     <span class="comment">%% Upsample to the filter sampling frequency</span>
0142                     up_factor = filts.fs/SYS_.signal_info.Fs;
0143                     [b,a] = butter( 9, 1/up_factor );
0144                     loudspeaker_signals_upsampled = zeros(size(Speaker_Signals,1)*up_factor, Setup.Loudspeaker_Count);
0145                     <span class="keyword">for</span> spkr = 1:Setup.Loudspeaker_Count
0146                         loudspeaker_signals_upsampled(:,spkr) = <span class="keyword">...</span>
0147                             filter( b, a, <span class="keyword">...</span>
0148                             interp( Speaker_Signals(:,spkr), up_factor ) );
0149                     <span class="keyword">end</span>
0150                     
0151                     <span class="keyword">if</span> ~isempty(orig)
0152                         orig_upsampled = filter( b, a, interp( orig, up_factor ) );
0153                     <span class="keyword">end</span>
0154                     
0155                     
0156                     <span class="comment">%% Calibrate</span>
0157                     loudspeaker_signals_calibrated = Tools.fconv( <span class="keyword">...</span>
0158                         loudspeaker_signals_upsampled, <span class="keyword">...</span>
0159                         filts.EQ );
0160                     <span class="keyword">if</span> ~isempty(orig)
0161                         orig_calibrated = Tools.fconv( <span class="keyword">...</span>
0162                             orig_upsampled, <span class="keyword">...</span>
0163                             [1; zeros(size(filts.EQ,1)-1,1)] );
0164                     <span class="keyword">end</span>
0165                     
0166                     <span class="comment">%% Save</span>
0167                     <span class="comment">% Normalise</span>
0168                     scale_value = 1 ./ max(abs(loudspeaker_signals_calibrated(:)));
0169                     loudspeaker_signals_calibrated = loudspeaker_signals_calibrated .* scale_value;
0170                     <span class="keyword">if</span> ~isempty(orig)
0171                         orig_calibrated = orig_calibrated ./ max(abs(orig_calibrated(:)));
0172                     <span class="keyword">end</span>
0173                     
0174                     output_dir = [SYS_.system_info.Drive SYS_.system_info.Calibrated_Signals_dir path_ext];
0175                     
0176                     <span class="keyword">if</span> ~exist(output_dir,<span class="string">'dir'</span>); mkdir(output_dir); <span class="keyword">end</span>
0177                     
0178                     <span class="keyword">if</span> sum(size(y)&gt;1) == 1 <span class="comment">% If not a multichannel audio file</span>
0179                         <span class="keyword">for</span> spkr = 1:Setup.Loudspeaker_Count
0180                             audiowrite([output_dir fileName_curr SYS_.system_info.sc <span class="string">'Upsampled'</span> SYS_.system_info.sc num2str(spkr) fileExt], <span class="keyword">...</span>
0181                                 loudspeaker_signals_calibrated(:,spkr), filts.fs);
0182                         <span class="keyword">end</span>
0183                     <span class="keyword">elseif</span> sum(size(y)&gt;1) &gt; 1 <span class="comment">% If a multichannel audio file</span>
0184                         audiowrite([output_dir fileName_curr SYS_.system_info.sc <span class="string">'Upsampled'</span> fileExt], <span class="keyword">...</span>
0185                             loudspeaker_signals_calibrated, filts.fs);
0186                     <span class="keyword">end</span>
0187                     save([output_dir fileName_curr SYS_.system_info.sc <span class="string">'Upsampled'</span> <span class="string">'.mat'</span>], <span class="string">'scale_value'</span>);
0188                     
0189                     <span class="keyword">if</span> ~isempty(orig)
0190                         audiowrite([output_dir fileName_curr SYS_.system_info.sc <span class="string">'Original'</span> fileExt], orig_calibrated, filts.fs );
0191                     <span class="keyword">end</span>
0192                     
0193                 <span class="keyword">end</span>
0194                 
0195                 fileName_prev = fileName_curr;
0196             <span class="keyword">end</span>
0197             n = Tools.showTimeToCompletion( (f + (m-1)*F) / (F*M), n);
0198         <span class="keyword">end</span>
0199     <span class="keyword">end</span>
0200     
0201     fprintf(<span class="string">'\nCompleted\n\n'</span>);
0202     
0203     <span class="comment">%Return values to normal</span>
0204     SYS_.signal_info.L_noise_mask = tmp_levels;
0205     <span class="comment">%     end</span>
0206 <span class="keyword">end</span>
0207 
0208 
0209 
0210</pre></div>
<hr><address>Generated on Sun 09-Jul-2017 20:35:18 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>