<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of Reverberant_MSR_batchfunc</title>
  <meta name="keywords" content="Reverberant_MSR_batchfunc">
  <meta name="description" content="">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="../index.html">+Room_Acoustics</a> &gt; <a href="index.html">+Apply_RIRs</a> &gt; Reverberant_MSR_batchfunc.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for +Room_Acoustics\+Apply_RIRs&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>Reverberant_MSR_batchfunc
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong></strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function Reverberant_MSR_batchfunc( SYS_or_room_setup, mask_type, main_setup, weight, mask_level, Conv_Type ) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function setup = swapZones(setup)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function Reverberant_MSR_batchfunc( SYS_or_room_setup, mask_type, main_setup, weight, mask_level, Conv_Type )</a>
0002 
0003 SYS_type = <span class="string">'Current_Systems.SR_System'</span>;
0004 
0005 <span class="comment">%% Initialise</span>
0006 tic;
0007 <span class="comment">% Start Parallel Pool</span>
0008 para_pool = parpool;
0009 C = clock;
0010 fprintf(<span class="string">'Started execution at %.0f:%.0f:%.0f on the %.0f/%.0f/%.0f\n'</span>,C([4:6 3:-1:1]))
0011 
0012 <span class="comment">%%</span>
0013 <span class="keyword">if</span> nargin == 1
0014     <span class="keyword">if</span> isa(SYS_or_room_setup,SYS_type)
0015         SYS = SYS_or_room_setup;
0016         main_setup = SYS.Main_Setup;
0017         masker_setup = SYS.Masker_Setup;
0018         room_setup = SYS.Room_Setup;
0019         signal_info = SYS.signal_info;
0020         system_info = SYS.system_info;
0021     <span class="keyword">else</span>
0022         error([<span class="string">'Single input argument must be of type: '</span> SYS_type]);
0023     <span class="keyword">end</span>
0024 <span class="keyword">elseif</span> nargin &gt; 1
0025     room_setup = SYS_or_room_setup;
0026     system_info.Drive = <span class="string">'Z:\'</span>; <span class="comment">% Database drive (storage drive)</span>
0027     system_info.LUT_resolution =  <span class="string">'512f_32w'</span>; <span class="comment">%Look-Up Table resolution</span>
0028     
0029     signal_info.c = 343; <span class="comment">% Speed of sound in metres/sec</span>
0030     signal_info.Fs = 16000; <span class="comment">% Sampling frequency</span>
0031     signal_info.Nfft = 1024;<span class="comment">% Number of fft components</span>
0032     signal_info.overlap = 0.5;
0033     signal_info.f_low  = 150;  <span class="comment">% Hz</span>
0034     signal_info.f_high = 8000; <span class="comment">% Hz</span>
0035     signal_info.weight = weight;
0036     signal_info.L_noise_mask = mask_level; <span class="comment">% dB</span>
0037     signal_info.method = mask_type;
0038     signal_info.input_filename = [];
0039     <span class="keyword">if</span> nargin &lt; 5
0040         signal_info.L_noise_mask = [];
0041     <span class="keyword">end</span>
0042     system_info.sc = <span class="string">'_'</span>; <span class="comment">% Separating character for ascii paths</span>
0043 <span class="keyword">end</span>
0044 
0045 <span class="keyword">if</span> nargin &lt; 6
0046     Conv_Type = <span class="string">'FFT'</span>;
0047 <span class="keyword">end</span>
0048 
0049 isMasker = ~isempty(strfind(lower(signal_info.method), <span class="string">'masker'</span>)); <span class="comment">%if a masker</span>
0050 <span class="comment">%% Set values depending on setup type (masker or clean)</span>
0051 <span class="keyword">if</span> ~isMasker <span class="comment">%if not a masker (clean)</span>
0052     setup = main_setup;
0053     levels = -inf;
0054 <span class="keyword">else</span> <span class="comment">%if a masker</span>
0055     setup = masker_setup;
0056     levels = signal_info.L_noise_mask;
0057 <span class="keyword">end</span>
0058 
0059 <span class="comment">%% Loudspeaker Signals Directory and Recordings Directory</span>
0060 LoudspeakerSignals_Path = cell(length(levels),1);
0061 Recordings_Path = cell(length(levels),1);
0062 
0063 <span class="keyword">for</span> m = 1:length(levels)
0064     signal_info.L_noise_mask = levels(m);
0065     LoudspeakerSignals_Path{m} = Broadband_Tools.getLoudspeakerSignalPath( setup, signal_info, system_info.LUT_resolution, system_info.Drive );
0066     Recordings_Path{m} = Results.getRecordingsPath( setup, system_info.LUT_resolution, room_setup, signal_info, system_info.Drive );
0067 <span class="keyword">end</span>
0068 
0069 signal_info.L_noise_mask = levels; <span class="comment">% Set values back to originals</span>
0070 
0071 <span class="comment">%% Load RIR Database file</span>
0072 method = {<span class="string">'new2'</span>, <span class="string">'new'</span>, <span class="string">'old'</span>};
0073 <span class="keyword">for</span> m = 1:length(method)
0074     [DB,err] = Room_Acoustics.loadRIRDatabaseFromSetup( main_setup, room_setup, system_info.Drive, method{m});
0075     <span class="keyword">if</span> ~err
0076         <span class="keyword">break</span>;
0077     <span class="keyword">elseif</span> m == length(method)
0078         error(<span class="string">'No matching RIR database file was found. (Generate one and try again)'</span>);
0079     <span class="keyword">end</span>
0080 <span class="keyword">end</span>
0081 
0082 
0083 <span class="comment">%% Find Speaker Signals and read to Workspace</span>
0084 fprintf(<span class="string">'\n====== Applying Room Impulse Responses to Loudspeaker-Signals ======\n'</span>);
0085 fprintf([<span class="string">'            Room Size: '</span> [strrep(room_setup.Room_Size_txt,<span class="string">'x'</span>,<span class="string">'m x '</span>) <span class="string">'m'</span>] <span class="string">'\n'</span>]);
0086 fprintf([<span class="string">'Wall Absorption Coeff: '</span> num2str(room_setup.Wall_Absorb_Coeff) <span class="string">'\n'</span>]);
0087 fprintf([<span class="string">' Virtual Source Angle: '</span> num2str(setup.Multizone_Soundfield.Bright_Zone.SourceOrigin.Angle) <span class="string">'\n'</span>]);
0088 fprintf([<span class="string">'       Privacy Method: '</span> signal_info.method <span class="string">'\n\n'</span>]);n=0;
0089 fprintf(<span class="string">'\tCompletion: '</span>);
0090 
0091 M = length(signal_info.L_noise_mask);
0092 <span class="keyword">for</span> m = 1:M
0093     
0094     files = Tools.getAllFiles( LoudspeakerSignals_Path{m} );
0095     files = sort(files);
0096     
0097     <span class="comment">% Continue with only the files that are contained in the original</span>
0098     <span class="comment">% source folder unless a Masker signal is being processed (these are</span>
0099     <span class="comment">% named as Maskers)</span>
0100     <span class="keyword">if</span> ~isMasker
0101         files = Tools.keepFilesFromFolder( files, signal_info.speech_filepath);
0102     <span class="keyword">end</span>
0103     <span class="keyword">if</span> isempty(files), error(<span class="string">'No loudspeaker signals found. Have they been generated?'</span>); <span class="keyword">end</span>    
0104     
0105     fileName_prev = <span class="string">''</span>;
0106     Speaker_Signals = [];
0107     
0108     F = length(files);
0109     <span class="keyword">for</span> f = 1:F
0110         
0111         [~, fileName, fileExt] = fileparts(files{f});
0112         <span class="keyword">if</span> isempty( strfind( fileName, <span class="string">'Original'</span> ) ) <span class="comment">% If not an Original audio file</span>
0113             <span class="keyword">try</span>
0114                 y = audioread(files{f});
0115             <span class="keyword">catch</span> err
0116                 <span class="keyword">if</span> strcmp(err.identifier, <span class="string">'MATLAB:audiovideo:audioread:FileTypeNotSupported'</span>)
0117                     <span class="keyword">continue</span>; <span class="comment">% Skip unsupported files</span>
0118                 <span class="keyword">end</span>
0119             <span class="keyword">end</span>
0120             
0121             <span class="comment">% Get the file number and file name</span>
0122             [fnumflip,fnameflip] = strtok( flip(fileName), SYS.system_info.sc );
0123             Current_Spkr_Num = str2double( flip( fnumflip ) );
0124             fileName_curr = flip(sscanf(fnameflip,[<span class="string">'%*['</span> SYS.system_info.sc <span class="string">']%s'</span>]));
0125             
0126             <span class="keyword">if</span> sum(size(y)&gt;1) == 1 &amp;&amp; setup.Loudspeaker_Count ~= 1 <span class="comment">% If not a multichannel audio file</span>
0127                 <span class="keyword">if</span> ~(isempty(fileName_prev) || strcmp( fileName_curr, fileName_prev))
0128                     Speaker_Signals_ = [];
0129                 <span class="keyword">end</span>
0130                 
0131                 Speaker_Signals_(Current_Spkr_Num,:) = y;
0132                 <span class="keyword">if</span> sum( any( Speaker_Signals_, 2 ) ) == SYS.Main_Setup.Loudspeaker_Count
0133                     Speaker_Signals = Speaker_Signals_;
0134                 <span class="keyword">end</span>
0135                 
0136             <span class="keyword">elseif</span> sum(size(y)&gt;1) &gt;= 1 &amp;&amp; setup.Loudspeaker_Count &gt;= 1 <span class="comment">% If a multichannel audio file</span>
0137                 Speaker_Signals = y.';
0138             <span class="keyword">else</span>
0139                 error([<span class="string">'Failed to read audio file: '</span> fileName]);
0140             <span class="keyword">end</span>
0141             
0142             <span class="keyword">if</span> sum( any( Speaker_Signals, 2 ) ) == setup.Loudspeaker_Count <span class="comment">% If we have a complete group of speaker signals</span>
0143                 <span class="comment">%% Re-Scale</span>
0144                 <span class="comment">% If we have a masker signal then we rescale that signal to</span>
0145                 <span class="comment">% its correct level. This is because it was scaled upon</span>
0146                 <span class="comment">% saving to audio format to prevent clipping.</span>
0147                 <span class="keyword">if</span> isfield(signal_info,<span class="string">'clipLevelAdjust'</span>)
0148                     common_scaler = 1/db2mag(signal_info.clipLevelAdjust);
0149                 <span class="keyword">end</span>
0150                 <span class="keyword">if</span> ~isempty(strfind(signal_info.method, <span class="string">'Masker'</span>))
0151                     <span class="keyword">if</span> signal_info.L_noise_mask(m) &lt;= 0
0152                         scaler = (db2mag(0)+1); <span class="comment">%Plus one is for the amplitude of the clean signal</span>
0153                     <span class="keyword">elseif</span> signal_info.L_noise_mask(m) &gt; 0 <span class="comment">% For a positive masker we scaled the signals to save up to a 40db noise masker</span>
0154                         scaler = (db2mag(40)+1);<span class="comment">%Plus one is for the amplitude of the clean signal</span>
0155                     <span class="keyword">end</span>
0156                     Speaker_Signals = Speaker_Signals .* scaler .* common_scaler;
0157                 <span class="comment">% The input signal may have also been scaled</span>
0158                 <span class="keyword">elseif</span> isfield(signal_info,<span class="string">'inputSignalNorm'</span>) &amp;&amp; signal_info.inputSignalNorm
0159                     Speaker_Signals = Speaker_Signals .* common_scaler;
0160                 <span class="keyword">end</span>
0161                 
0162                 <span class="comment">%% Parametric Level adjust</span>
0163                 <span class="comment">% If we have a parametric array we apply the true</span>
0164                 <span class="comment">% ultrasonic reproduction level of that array</span>
0165                 <span class="keyword">if</span> strcmp( setup.Loudspeaker_Type, <span class="string">'Parametric'</span> )
0166                     Speaker_Signals = Speaker_Signals .* setup.Loudspeaker_Object.P1;
0167                 <span class="keyword">end</span>
0168                 
0169                 <span class="comment">%% Perform RIR Convolution with Loudspeaker Signals</span>
0170                 <span class="comment">% Bright Zone Signals</span>
0171                 Rec_Sigs_B = Room_Acoustics.Apply_RIRs.Convolve_SpkrSigs_and_RIRs( <span class="keyword">...</span>
0172                     Speaker_Signals, DB.RIRs.Bright_RIRs, Conv_Type);
0173                 <span class="comment">% Quiet Zone Signals</span>
0174                 Rec_Sigs_Q = Room_Acoustics.Apply_RIRs.Convolve_SpkrSigs_and_RIRs( <span class="keyword">...</span>
0175                     Speaker_Signals, DB.RIRs.Quiet_RIRs, Conv_Type);
0176                 
0177                 <span class="comment">%% Read original file</span>
0178                 <span class="keyword">if</span> isempty(strfind(signal_info.method, <span class="string">'Masker'</span>)) <span class="comment">% If the signals are not Maskers then read the Original audio</span>
0179                     <span class="keyword">try</span>
0180                         orig = audioread( [LoudspeakerSignals_Path{m}, fileName_curr, system_info.sc, <span class="string">'Original'</span>, fileExt] ); <span class="comment">% Assumes same file extension as loudspeaker audio files</span>
0181                     <span class="keyword">catch</span> err
0182                         <span class="keyword">if</span> strcmp(err.identifier, <span class="string">'MATLAB:audiovideo:audioread:FileTypeNotSupported'</span>)
0183                             error(<span class="string">'Error reading the Original audio file for the reproduction.'</span>); <span class="comment">% Skip unsupported files</span>
0184                         <span class="keyword">end</span>
0185                     <span class="keyword">end</span>
0186                 <span class="keyword">else</span>
0187                     orig=[];
0188                 <span class="keyword">end</span>
0189                 
0190                 <span class="comment">%% Save receiver recordings</span>
0191                 Room_Acoustics.Apply_RIRs.Save_Reverb_Recording( orig, Rec_Sigs_B, Rec_Sigs_Q, signal_info.Fs, Recordings_Path{m}, <span class="string">''</span>, fileName_curr, fileExt );
0192                 
0193             <span class="keyword">end</span>
0194             
0195             fileName_prev = fileName_curr;
0196             
0197         <span class="keyword">end</span>
0198         
0199         [n] = Tools.showTimeToCompletion( ((m-1)*F + f) / (F*M), n);
0200     <span class="keyword">end</span>
0201     
0202 <span class="keyword">end</span>
0203 
0204 
0205 
0206 <span class="comment">%%</span>
0207 tEnd = toc;
0208 fprintf(<span class="string">'\nExecution time: %dmin(s) %fsec(s)\n\n'</span>, floor(tEnd/60), rem(tEnd,60)); <span class="comment">%Time taken to execute this script</span>
0209 
0210 <span class="comment">% Delete Parallel Pool</span>
0211 delete(para_pool);
0212 
0213 <span class="keyword">end</span>
0214 
0215 <a name="_sub1" href="#_subfunctions" class="code">function setup = swapZones(setup)</a>
0216 Zone = setup.Multizone_Soundfield.Bright_Zone;
0217 setup.Multizone_Soundfield.Bright_Zone = <span class="keyword">...</span>
0218     setup.Multizone_Soundfield.Quiet_Zone;
0219 setup.Multizone_Soundfield.Quiet_Zone = Zone;
0220 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Sun 09-Jul-2017 20:35:18 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>