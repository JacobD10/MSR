<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of Reverberant_MSR_Analysis_batchfunc</title>
  <meta name="keywords" content="Reverberant_MSR_Analysis_batchfunc">
  <meta name="description" content="">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="../index.html">+Room_Acoustics</a> &gt; <a href="index.html">+Apply_RIRs</a> &gt; Reverberant_MSR_Analysis_batchfunc.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for +Room_Acoustics\+Apply_RIRs&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>Reverberant_MSR_Analysis_batchfunc
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong></strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function Reverberant_MSR_Analysis_batchfunc( SYS_or_setups, room_setup, signal_types, weight, mask_level, pesqNumber, RecordingType) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [Rec_B, Rec_Q] = adjustHybridMaskers(Rec_B, Rec_Q, Setups, SigInfo)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function Reverberant_MSR_Analysis_batchfunc( SYS_or_setups, room_setup, signal_types, weight, mask_level, pesqNumber, RecordingType)</a>
0002 
0003 SYS_type = <span class="string">'Current_Systems.SR_System'</span>;
0004 
0005 <span class="comment">%% Initialise</span>
0006 tic;
0007 <span class="comment">% Start Parallel Pool</span>
0008 para_pool = parpool;
0009 C = clock;
0010 fprintf(<span class="string">'Started execution at %.0f:%.0f:%.0f on the %.0f/%.0f/%.0f\n'</span>,C([4:6 3:-1:1]))
0011 
0012 <span class="comment">%%</span>
0013 <span class="keyword">if</span> nargin == 1
0014     <span class="keyword">if</span> isa(SYS_or_setups,SYS_type)
0015         SYS = SYS_or_setups;
0016         Mains = num2cell(SYS.Main_Setup);
0017         Maskers = num2cell(SYS.Masker_Setup);
0018         setups = {Mains{:},Maskers{:}};
0019         room_setup = SYS.Room_Setup;
0020         signal_types = SYS.signal_info.methods_list;
0021         signal_info = SYS.signal_info;
0022         system_info = SYS.system_info;
0023         analysis_info = SYS.analysis_info;
0024         isHybrid = size(SYS.signal_info.methods_list_masker,1)&gt;1;
0025     <span class="keyword">else</span>
0026         error([<span class="string">'Single input argument must be of type: '</span> SYS_type]);
0027     <span class="keyword">end</span>
0028 <span class="keyword">elseif</span> nargin &gt; 1
0029     setups = SYS_or_setups;
0030     system_info.Drive = <span class="string">'Z:\'</span>; <span class="comment">% Database drive (storage drive)</span>
0031     system_info.LUT_resolution =  <span class="string">'512f_32w'</span>; <span class="comment">%Look-Up Table resolution</span>
0032     signal_info.c = 343; <span class="comment">% Speed of sound in metres/sec</span>
0033     signal_info.Fs = 16000; <span class="comment">% Sampling frequency</span>
0034     signal_info.Nfft = 1024;<span class="comment">% Number of fft components</span>
0035     signal_info.overlap = 0.5;
0036     signal_info.f_low  = 150;  <span class="comment">% Hz</span>
0037     signal_info.f_high = 8000; <span class="comment">% Hz</span>
0038     signal_info.f_low_meas = 100; <span class="comment">% Hz %Minimum loudspeaker response</span>
0039     signal_info.f_high_meas = 7000; <span class="comment">% Hz %Maximum frequency with accurate response at given sampling rate</span>
0040     signal_info.weight = weight;
0041     signal_info.L_noise_mask = mask_level; <span class="comment">% dB</span>
0042     signal_info.input_filename = [];
0043     analysis_info.Measures = {<span class="string">'PESQ'</span>,<span class="string">'STOI'</span>,<span class="string">'SNR'</span>};
0044     isHybrid = length(signal_types) &gt;= 3;
0045     <span class="keyword">if</span> nargin &lt; 7
0046         RecordingType = <span class="string">'simulated'</span>;
0047     <span class="keyword">end</span>
0048     signal_info.recording_type = RecordingType;
0049     <span class="keyword">if</span> nargin &lt; 5
0050         signal_info.L_noise_mask = [];
0051     <span class="keyword">end</span>
0052     system_info.sc = <span class="string">'_'</span>; <span class="comment">% Separating character for ascii paths</span>
0053 <span class="keyword">end</span>
0054 
0055 <span class="keyword">if</span> nargin &lt; 6
0056     pesqNumber = 0;
0057 <span class="keyword">end</span>
0058 Measures = analysis_info.Measures;
0059 
0060 signal_type = [signal_types{2:end}];
0061 
0062 
0063 signal_info.recording_type = strrep(signal_info.recording_type,<span class="string">'-'</span>,<span class="string">''</span>);
0064 isSimulated = strcmpi(signal_info.recording_type,<span class="string">'simulated'</span>);
0065 isRealworld = strcmpi(signal_info.recording_type,<span class="string">'realworld'</span>);
0066 isSweep     = isempty(signal_type) &amp;&amp; any(strcmp(analysis_info.Measures,<span class="string">'SPL'</span>));
0067 
0068 
0069 <span class="keyword">if</span> isHybrid
0070     signal_type = [<span class="string">'Hybrid'</span> signal_type];
0071 <span class="keyword">end</span>
0072 <span class="keyword">if</span> isSweep
0073     signal_type = <span class="string">'Sweep'</span>; <span class="comment">% An exponential sine sweep is what is used to measure SPL with this framework</span>
0074 <span class="keyword">end</span>
0075 signal_info.method = signal_type;
0076 
0077 
0078 <span class="comment">%% Obtain Recordings and Results Directory Path</span>
0079 ResultsPath = Results.getResultsPath( setups{1}, system_info.LUT_resolution, room_setup, signal_info, system_info.Drive );
0080 <span class="keyword">if</span> ~exist(ResultsPath,<span class="string">'dir'</span>); mkdir(ResultsPath); <span class="keyword">end</span>
0081 save([ResultsPath <span class="string">'Setups.mat'</span>], <span class="string">'setups'</span>);
0082 
0083 levels = signal_info.L_noise_mask;
0084 weight = signal_info.weight;
0085 Recordings_Path = cell(length(levels),length(setups));
0086 
0087 <span class="keyword">if</span> isSimulated
0088     s_1 = 1;
0089 <span class="keyword">elseif</span> isRealworld
0090     s_1 = 2;
0091     <span class="keyword">if</span> isSweep
0092         s_1 = 1;
0093     <span class="keyword">end</span> 
0094 <span class="keyword">end</span>
0095 
0096 <span class="keyword">for</span> s = s_1:length(setups)
0097     signal_info.method = signal_types{s};
0098     <span class="keyword">if</span> isempty(strfind( signal_types{s}, <span class="string">'Parametric'</span> )) <span class="comment">% If not parametric and more than one loudspeaker</span>
0099         signal_info.weight = weight;
0100     <span class="keyword">else</span> <span class="comment">% If parametric and/or only one loudspeaker</span>
0101         signal_info.weight = 1;
0102     <span class="keyword">end</span>
0103     <span class="keyword">for</span> m = 1:length(levels)
0104         <span class="keyword">if</span> any(s == signal_info.methods_list_clean)
0105             signal_info.L_noise_mask = -Inf; <span class="comment">%Masker level is non-existent for clean setup (speech setup)</span>
0106         <span class="keyword">elseif</span> any(s == signal_info.methods_list_masker)
0107             signal_info.L_noise_mask = levels(m);
0108         <span class="keyword">else</span>
0109             error(<span class="string">'Setup index not defined in ''methods_list_clean'' or ''methods_list_masker''.'</span>)
0110         <span class="keyword">end</span>
0111         <span class="keyword">if</span> isSimulated
0112             Recordings_Path{m,s} = Results.getRecordingsPath( setups{s}, system_info.LUT_resolution, room_setup, signal_info, system_info.Drive );
0113         <span class="keyword">elseif</span> isRealworld
0114             Recordings_Path{m,s} = Hardware_Control.getRealRecordingsPath( setups{1}, system_info.LUT_resolution, room_setup, signal_info, system_info.Drive );
0115         <span class="keyword">end</span>
0116     <span class="keyword">end</span>
0117 <span class="keyword">end</span>
0118 signal_info.L_noise_mask = levels;
0119 signal_info.weight = weight;
0120 signal_info.method = signal_type;
0121 
0122 
0123 <span class="comment">%% Delete previous results file</span>
0124 Results.deleteResultsFile( ResultsPath, analysis_info.Measures);
0125 
0126 <span class="comment">%% Start Evaluation Loop</span>
0127 <span class="keyword">if</span> isSimulated
0128     EnvType = <span class="string">'Simulated'</span>;
0129 <span class="keyword">elseif</span> isRealworld
0130     EnvType = <span class="string">'Real-World'</span>;
0131 <span class="keyword">end</span>
0132 fprintf([<span class="string">'\n====== Analysing '</span> EnvType <span class="string">' Reverberant Signals ======\n'</span>]);
0133 fprintf([<span class="string">'            Room Size: '</span> [strrep(sprintf(strrep(repmat(<span class="string">'%g'</span>,1,length(room_setup.Room_Size)),<span class="string">'g%'</span>,<span class="string">'g %'</span>),room_setup.Room_Size),<span class="string">' '</span>,<span class="string">'m x '</span>) <span class="string">'m'</span>] <span class="string">'\n'</span>]);
0134 fprintf([<span class="string">'Wall Absorption Coeff: '</span> num2str(room_setup.Wall_Absorb_Coeff) <span class="string">'\n'</span>]);
0135 fprintf([<span class="string">' Virtual Source Angle: '</span> num2str(setups{1}.Multizone_Soundfield.Bright_Zone.SourceOrigin.Angle) <span class="string">'\n'</span>]);
0136 fprintf([<span class="string">'    Privacy Weighting: '</span> signal_info.method <span class="string">'\n\n'</span>]);n=0;
0137 fprintf(<span class="string">'\tCompletion: '</span>);
0138 
0139 
0140 <span class="comment">%% Find Speaker Signals and read to Workspace</span>
0141 M = length(signal_info.L_noise_mask);
0142 S = length(setups);
0143 <span class="keyword">for</span> m = 1:M
0144     
0145     files = {[],[]};
0146     <span class="keyword">for</span> s=s_1:S
0147         files_ = Tools.getAllFiles( Recordings_Path{m,s} );
0148         <span class="comment">% Continue with only the files that are contained in the original</span>
0149         <span class="comment">% source folder</span>
0150         <span class="keyword">if</span> s==s_1
0151             files_ = Tools.keepFilesFromFolder( files_, signal_info.speech_filepath);
0152         <span class="keyword">end</span>
0153         <span class="comment">% Warn if there are no recordings to analyse and then return from the function</span>
0154         <span class="keyword">if</span> isempty(files_)
0155             wrnCol = [255,100,0]/255;
0156             cprintf(wrnCol, <span class="string">'There was a problem reading associated recording files.\n'</span>);
0157             cprintf(wrnCol, [<span class="string">'Do '''</span> signal_info.recording_type <span class="string">''' recordings exist?\n'</span>]);
0158             cprintf(wrnCol, [<span class="string">'Skipping '''</span> signal_info.recording_type <span class="string">''' analysis procedure.\n'</span>]);
0159             delete(gcp(<span class="string">'nocreate'</span>)); <span class="keyword">return</span>;
0160         <span class="keyword">end</span>
0161         files{:,s} = sort(files_);
0162     <span class="keyword">end</span>
0163     
0164     fileName_prev = <span class="string">''</span>;
0165     Rec_Bright = [];
0166     Rec_Quiet = [];
0167     Fs = signal_info.Fs;
0168     
0169     <span class="comment">% Load maskers</span>
0170     <span class="keyword">for</span> s=s_1:S
0171         <span class="keyword">if</span> any(s == signal_info.methods_list_masker) || <span class="keyword">...</span>
0172             (all(signal_info.methods_list_masker==0) &amp;&amp; any(strcmp(analysis_info.Measures,<span class="string">'SPL'</span>)))
0173             fileName={};
0174             i=(all(signal_info.methods_list_masker==0) &amp;&amp; any(strcmp(analysis_info.Measures,<span class="string">'SPL'</span>)))*1;
0175             fpos = [1 (s_1+1+i)];
0176             <span class="keyword">for</span> f=fpos
0177                 [~, fileName{s,f}, ~] = fileparts(files{s}{f});
0178             <span class="keyword">end</span>
0179             <span class="comment">% These should be maskers unless realworld recording</span>
0180             Rec_Bright_{s} = load(files{s}{fpos(1)});
0181             Rec_Quiet_{s} = load(files{s}{fpos(2)});
0182             <span class="keyword">if</span> isfield(Rec_Bright_{s},<span class="string">'fs'</span>)
0183                 Fs = Rec_Bright_{s}.fs;
0184             <span class="keyword">end</span>
0185         <span class="keyword">end</span>
0186     <span class="keyword">end</span>
0187     <span class="comment">%     if S == 3 % If two maskers are found</span>
0188     <span class="comment">%         [Rec_Bright_, Rec_Quiet_] = adjustHybridMaskers( ...</span>
0189     <span class="comment">%             Rec_Bright_, Rec_Quiet_, setups, signal_info);</span>
0190     <span class="comment">%     end</span>
0191     
0192     F = size(files{s_1},1);
0193     <span class="keyword">for</span> file = 1:F
0194         
0195         [~, fileName{s_1,file}, ~] = fileparts(files{s_1}{file});
0196         
0197         
0198         <span class="keyword">if</span> isempty(strfind(fileName{s_1,file},<span class="string">'Original'</span>)) <span class="comment">% Make sure the file being read isn't an original file</span>
0199             
0200             <span class="comment">% Get the file number and file name</span>
0201             [Ztypeflip,Stypeflip] = strtok( flip(fileName{s_1,file}), system_info.sc );
0202             SignalName = flip( Stypeflip );
0203             ZoneType = flip( Ztypeflip );
0204             
0205             
0206             <span class="keyword">if</span> ~(isempty(fileName_prev) || strcmp( SignalName, fileName_prev))
0207                 Rec_Bright = [];
0208                 Rec_Quiet = [];
0209             <span class="keyword">end</span>
0210             
0211             <span class="keyword">if</span> strcmp(<span class="string">'Bright'</span>,ZoneType)
0212                 Rec_Bright = [];
0213                 <span class="keyword">for</span> s = signal_info.methods_list_clean.'
0214                     <span class="keyword">if</span> ~isempty(files{s})
0215                         Rec_Bright_{s} = load(files{s}{file});
0216                     <span class="keyword">else</span>
0217                         Rec_Bright_{s_1} = load(files{s_1}{file}); <span class="keyword">break</span>;
0218                     <span class="keyword">end</span>
0219                 <span class="keyword">end</span>
0220                 <span class="keyword">if</span> s_1==2, Rec_Bright_{s_1}.Rec_Sigs_B = Rec_Bright_{s_1}.Rec_Sigs_B'; <span class="keyword">end</span> <span class="comment">%TODO: Fix the recording so the dimensions are in the correct place.</span>
0221                 sLB = size( Rec_Bright_{s_1}.Rec_Sigs_B,2); <span class="comment">%signal Length Bright</span>
0222                 <span class="keyword">for</span> s=s_1:S
0223                     Rec_Bright(:,:,s) = Rec_Bright_{s}.Rec_Sigs_B(:,1:sLB);
0224                 <span class="keyword">end</span>
0225                 Rec_Bright = sum( Rec_Bright, 3 );
0226                 [~,Iforce]=sort(size(Rec_Bright)); 
0227                 Rec_Bright=permute(Rec_Bright,Iforce);<span class="comment">% Force smaller dimension first</span>
0228             <span class="keyword">elseif</span> strcmp(<span class="string">'Quiet'</span>,ZoneType)
0229                 Rec_Quiet = [];
0230                 <span class="keyword">for</span> s = signal_info.methods_list_clean.'
0231                     <span class="keyword">if</span> ~isempty(files{s})
0232                         Rec_Quiet_{s} = load(files{s}{file});
0233                     <span class="keyword">else</span>
0234                         Rec_Quiet_{s_1} = load(files{s_1}{file}); <span class="keyword">break</span>;
0235                     <span class="keyword">end</span>
0236                 <span class="keyword">end</span>
0237                 <span class="keyword">if</span> s_1==2, Rec_Quiet_{s_1}.Rec_Sigs_Q = Rec_Quiet_{s_1}.Rec_Sigs_Q'; <span class="keyword">end</span>; <span class="comment">%TODO: Fix the recording so the dimensions are in the correct place.</span>
0238                 sLQ = size( Rec_Quiet_{s_1}.Rec_Sigs_Q,2); <span class="comment">%signal Length Quiet</span>
0239                 <span class="keyword">for</span> s=s_1:S
0240                     Rec_Quiet(:,:,s) = Rec_Quiet_{s}.Rec_Sigs_Q(:,1:sLQ);
0241                 <span class="keyword">end</span>
0242                 Rec_Quiet = sum( Rec_Quiet, 3 );
0243                 [~,Iforce]=sort(size(Rec_Quiet)); 
0244                 Rec_Quiet=permute(Rec_Quiet,Iforce);<span class="comment">% Force smaller dimension first</span>
0245             <span class="keyword">else</span>
0246                 error(<span class="string">'Error reading the recordings. The type of zone read from the file name is not supported'</span>);
0247             <span class="keyword">end</span>
0248             
0249             <span class="keyword">if</span> all( [any(Rec_Bright(:)), any(Rec_Quiet(:))] ) <span class="comment">% If we have two complete group of receiver signals for each zone</span>
0250                 
0251                 <span class="comment">% Read original file</span>
0252                 <span class="keyword">for</span> file_orig = 1:F
0253                     <span class="keyword">if</span> ~isempty( strfind(files{s_1}{file_orig}, [SignalName <span class="string">'Original'</span>]) )
0254                         <span class="keyword">break</span>
0255                     <span class="keyword">end</span>
0256                 <span class="keyword">end</span>
0257                 <span class="keyword">try</span>
0258                     orig = audioread( files{s_1}{file_orig} );
0259                 <span class="keyword">catch</span> err
0260                     <span class="keyword">if</span> strcmp(err.identifier, <span class="string">'MATLAB:audiovideo:audioread:FileTypeNotSupported'</span>)
0261                         <span class="keyword">continue</span>; <span class="comment">% Skip unsupported files</span>
0262                     <span class="keyword">end</span>
0263                 <span class="keyword">end</span>
0264                 
0265                 
0266                 <span class="comment">% BEGIN Downsample realworld recordings</span>
0267                 <span class="keyword">if</span> Fs ~= signal_info.Fs
0268                     down_rate = Fs / signal_info.Fs ;
0269                     Rec_Bright_down = zeros(ceil(size(Rec_Bright).*[1 1/down_rate]));
0270                     Rec_Quiet_down = zeros(ceil(size(Rec_Quiet).*[1 1/down_rate]));
0271                     <span class="keyword">for</span>  r = 1:size(Rec_Bright,1)
0272                         Rec_Bright_down(r,:) = <span class="keyword">...</span>
0273                             decimate( Rec_Bright(r,:), down_rate );
0274                         Rec_Quiet_down(r,:) = <span class="keyword">...</span>
0275                             decimate( Rec_Quiet(r,:), down_rate );
0276                     <span class="keyword">end</span>
0277                     Rec_Bright = Rec_Bright_down;
0278                     Rec_Quiet  = Rec_Quiet_down ;
0279                     <span class="keyword">if</span> ~isempty(orig)
0280                         orig = decimate( orig, down_rate );
0281                     <span class="keyword">end</span>
0282                 <span class="keyword">end</span>
0283                 <span class="comment">% END Downsample realworld recordings</span>
0284                 
0285                 <span class="keyword">if</span> ~any(cell2mat(strfind(upper(Measures),<span class="string">'SUPPRESSION'</span>)))
0286                     <span class="comment">% BEGIN filter signals to acceptable measurement frequency range</span>
0287                     [b,a] = butter(6, [signal_info.f_low_meas signal_info.f_high_meas] ./ (signal_info.Fs/2) );
0288                     <span class="comment">%[b,a] = cheby1(6 [signal_info.f_low_meas signal_info.f_high_meas] ./ (signal_info.Fs/2) );</span>
0289                     orig = filter(b,a,orig);
0290                     Rec_Bright = filter(b,a,Rec_Bright')';
0291                     Rec_Quiet  = filter(b,a,Rec_Quiet')';
0292                     <span class="comment">% END filter signals</span>
0293                     
0294                     <span class="comment">% BEGIN power normalise to bright zone level</span>
0295                     adjScale = [];
0296                     <span class="keyword">for</span> r = 1:size(Rec_Bright,1)
0297                         [~,adjScale(r)] = Broadband_Tools.power_norm(orig, Rec_Bright(r,:), signal_info.Fs, [signal_info.f_low_meas signal_info.f_high_meas]);
0298                     <span class="keyword">end</span>
0299                     Rec_Bright = Rec_Bright * mean(adjScale);
0300                     Rec_Quiet  = Rec_Quiet * mean(adjScale);
0301                     <span class="comment">% END power normalise</span>
0302                     
0303                     <span class="comment">% BEGIN Resize the original speech signal and</span>
0304                     <span class="comment">% Align it with the reverberant signals.</span>
0305                     orig(length(orig):size(Rec_Bright,2))=0; <span class="comment">% Resize the original signal because the reverberant signal will be longer</span>
0306                     <span class="keyword">if</span> (length(orig) ~= length(Rec_Bright)) || (length(orig) ~= length(Rec_Quiet))
0307                         error(<span class="string">'Size of the original signal does not match the reproduced signal!'</span>);
0308                     <span class="keyword">end</span>
0309                     
0310                     <span class="comment">%c_speed = 343;%343m/s speed of sound in air</span>
0311                     <span class="comment">%max_delay = speaker_radius*2 / c_speed * signal_info.Fs;</span>
0312                     max_delay = signal_info.Fs / 2;
0313                     Original = zeros( size(Rec_Bright,1), 2, <span class="keyword">...</span>
0314                         max( [length(orig), size(Rec_Bright,2), size(Rec_Quiet,2)] ) + max_delay );
0315                     Rec_BrightTMP = zeros(size(Rec_Bright,1),size(Original,3));
0316                     Rec_QuietTMP  = zeros(size(Rec_Quiet ,1),size(Original,3));
0317                     <span class="keyword">for</span> r = 1:size(Rec_Bright,1)
0318                         [tmp1, tmp2] = alignsignals( orig, Rec_Bright(r,:), max_delay);
0319                         [tmp3, tmp4]  = alignsignals( orig, Rec_Quiet(r,:),  max_delay);
0320                         Original(r,1,1:numel(tmp1)) = tmp1;
0321                         Rec_BrightTMP(r,1:numel(tmp2)) = tmp2;
0322                         Original(r,2,1:numel(tmp3)) = tmp3;
0323                         Rec_QuietTMP(r,1:numel(tmp4))  = tmp4;
0324                     <span class="keyword">end</span>
0325                     Rec_Bright = Rec_BrightTMP;
0326                     Rec_Quiet = Rec_QuietTMP;
0327                     <span class="comment">% END resize and align</span>
0328                 <span class="keyword">end</span>
0329                 
0330                 <span class="comment">% BEGIN Calculate and save results</span>
0331                 <span class="comment">%%% ANALYSIS</span>
0332                 <span class="comment">% Speech Quality</span>
0333                 <span class="keyword">if</span> any(cell2mat(strfind(upper(Measures),<span class="string">'PESQ'</span>)))
0334                     <span class="comment">% PESQ - Perceptual Evaluation of Speech Quality</span>
0335                     Room_Acoustics.Apply_RIRs.Save_Reverb_PESQ_Result( Original, Rec_Bright, signal_info.Fs, signal_info.L_noise_mask(m), ResultsPath, [], SignalName, pesqNumber );
0336                 <span class="keyword">end</span>
0337                 
0338                 <span class="comment">% Speech Intelligibility</span>
0339                 <span class="keyword">if</span> any(cell2mat(strfind(upper(Measures),<span class="string">'STOI'</span>)))
0340                     <span class="comment">% STOI - Short-Time Objective Intelligibility</span>
0341                     Room_Acoustics.Apply_RIRs.Save_Reverb_STOI_Result( Original, Rec_Bright, Rec_Quiet, signal_info.Fs, signal_info.L_noise_mask(m), ResultsPath, [], SignalName );
0342                 <span class="keyword">end</span>
0343                 <span class="keyword">if</span> any(cell2mat(strfind(upper(Measures),<span class="string">'STI'</span>)))
0344                     <span class="comment">% STI - Speech Transmission Index</span>
0345                     Room_Acoustics.Apply_RIRs.Save_Reverb_STI_Result( Original, Rec_Bright, Rec_Quiet, signal_info.Fs, ResultsPath, [], SignalName );
0346                 <span class="keyword">end</span>
0347                 
0348                 <span class="keyword">if</span> any(cell2mat(strfind(upper(Measures),<span class="string">'SNR'</span>)))
0349                     <span class="comment">% SNR - Signal to Noise Ratio</span>
0350                     Room_Acoustics.Apply_RIRs.Save_Reverb_SNR_Result( Original, Rec_Bright, Rec_Quiet, signal_info.Fs, signal_info.L_noise_mask(m), ResultsPath, [], SignalName );
0351                 <span class="keyword">end</span>
0352                 
0353                 <span class="keyword">if</span> any(cell2mat(strfind(upper(Measures),<span class="string">'SUPPRESSION'</span>)))
0354                     <span class="comment">% Interference Suppression</span>
0355                     Room_Acoustics.Apply_RIRs.Save_Reverb_Suppression_Result( Rec_Bright_{end}.Rec_Sigs_B(:,1:sLB), Rec_Bright, signal_info.Fs, <span class="keyword">...</span>
0356                         analysis_info.Nfft, [analysis_info.f_low, analysis_info.f_high], ResultsPath, [], SignalName );
0357                 <span class="keyword">end</span>
0358                 
0359                 <span class="keyword">if</span> any(cell2mat(strfind(upper(Measures),<span class="string">'SPL'</span>)))
0360                     <span class="comment">% Sound Pressure Levels</span>
0361                     Room_Acoustics.Apply_RIRs.Save_Reverb_SPLs_Result( Rec_Bright, Rec_Quiet, signal_info.Fs, <span class="keyword">...</span>
0362                         analysis_info.Nfft, [analysis_info.f_low, analysis_info.f_high], ResultsPath, [], SignalName, SYS );
0363                 <span class="keyword">end</span>
0364                 <span class="comment">% END calc and save results</span>
0365                 
0366             <span class="keyword">end</span>
0367             
0368             fileName_prev = SignalName;
0369             
0370         <span class="keyword">end</span>
0371         
0372         n = Tools.showTimeToCompletion( ((m-1)*F + file)/ (F*M), n);
0373         
0374     <span class="keyword">end</span>
0375 <span class="keyword">end</span>
0376 
0377 <span class="comment">%%</span>
0378 tEnd = toc;
0379 fprintf(<span class="string">'\nExecution time: %dmin(s) %fsec(s)\n\n'</span>, floor(tEnd/60), rem(tEnd,60)); <span class="comment">%Time taken to execute this script</span>
0380 
0381 <span class="comment">% Delete Parallel Pool</span>
0382 delete(para_pool);
0383 
0384 <span class="keyword">end</span>
0385 
0386 <a name="_sub1" href="#_subfunctions" class="code">function [Rec_B, Rec_Q] = adjustHybridMaskers(Rec_B, Rec_Q, Setups, SigInfo) </a><span class="comment">% Assumes two maskers only</span>
0387 <span class="comment">% Find cutoff from multizone setup</span>
0388 S = Setups{1};
0389 BZ = S.Multizone_Soundfield.Bright_Zone;
0390 QZ = S.Multizone_Soundfield.Quiet_Zone;
0391 R_ = max( [BZ.Radius_q + BZ.Origin_q.Distance; <span class="keyword">...</span>
0392     QZ.Radius_q + QZ.Origin_q.Distance;  ]);
0393 phiL_rad = S.Speaker_Arc_Angle / 180 * pi;
0394 f_cutoff = SigInfo.c * (S.Loudspeaker_Count - 1) / (2 * R_ * phiL_rad);
0395 f_cutoff = mean(f_cutoff .* [1, 2]);
0396 
0397 <span class="comment">% Match two signals</span>
0398 <span class="comment">% Adjust second masker to suit first</span>
0399 [newsig, adjVal] = Broadband_Tools.power_norm( Rec_Q{2}.Rec_Sigs_Q', Rec_Q{3}.Rec_Sigs_Q', SigInfo.Fs, f_cutoff );
0400 Rec_Q{3}.Rec_Sigs_Q = newsig';
0401 Rec_B{3}.Rec_Sigs_B = Rec_B{3}.Rec_Sigs_B * adjVal; <span class="comment">% Same adjustment to bright second masker</span>
0402 
0403 <span class="keyword">end</span>
0404</pre></div>
<hr><address>Generated on Sun 09-Jul-2017 20:35:18 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>